# Config file for Dinosaur Planet Recompilation.

[input]
entrypoint = 0x80000400
# Paths are relative to the location of this config file.
output_func_path = "RecompiledFuncs"
rom_file_path = "baserom.z64"
symbols_file_path = "dino.syms.toml"
relocatable_sections_path = "dino.dlls.txt"

[patches]
stubs = [
    "test_write",
    "check_dongle",
]

ignored = [
    "__osMakeMotorData",
    # replaced with custom recomp implementations
    "dummied_print_func",
    "proutSyncPrintf",
    # unused problematic funcs
    "func_80011588",
    "func_80011490",
    "NOTosContSetch",
    "set_osPIHandle_Addr_to_0xa800000",
    "some_dma_func",
    "osEPi_WriteRead",
    "func_8005EE8C",
    "func_8005EFA8",
    "func_8005F1A0",
    "func_8005EE20",
    "func_8005F0D4",
    "func_8005F2A4"
]

# Hook DLL loading/unloading up to N64ModernRuntime's overlay system
[[patches.hook]]
before_vram = 0x8000BF84
func = "dll_load"
text = "gpr dllId = ctx->r25;"
[[patches.hook]]
before_vram = 0x8000C028
func = "dll_load"
text = "load_overlay_by_id(dllId - 1, ctx->r2 + MEM_W(0, ctx->r2));"

[[patches.hook]]
before_vram = 0x8000C2B4
func = "func_8000C258"
text = "gpr dllListIdx = ctx->r2;"
[[patches.hook]]
before_vram = 0x8000C340
func = "func_8000C258"
text = "unload_overlay_by_id(MEM_W(dllListIdx * 0x10, MEM_W(0, 0xFFFFFFFF800A7D10)) - 1);"

# DLL 31 contains the osFlash functions, redirect them to the recomp versions
[[patches.hook]]
func = "dll_31_func_4DC"
text = "osFlashInit_recomp(rdram, ctx); return;"

[[patches.hook]]
func = "dll_31_func_640"
text = "osFlashReadId_recomp(rdram, ctx); return;"

[[patches.hook]]
func = "dll_31_func_820"
text = "osFlashClearStatus_recomp(rdram, ctx); return;"

[[patches.hook]]
func = "dll_31_func_88C"
text = "osFlashSectorErase_recomp(rdram, ctx); return;"

[[patches.hook]]
func = "dll_31_func_9A4"
text = "osFlashWriteBuffer_recomp(rdram, ctx); return;"

[[patches.hook]]
func = "dll_31_func_A50"
text = "osFlashWriteArray_recomp(rdram, ctx); return;"

[[patches.hook]]
func = "dll_31_func_B48"
text = "osFlashReadArray_recomp(rdram, ctx); return;"

# replace PI_STATUS check with yield
[[patches.hook]]
before_vram = 0x800012d8
func = "func_80001220"
text = "yield_self(rdram);"
[[patches.instruction]]
vram = 0x800012d8
func = "func_80001220"
value = 0x00001025 # lw v0,0x0(v1) -> or v0,zero,zero

# osAiGetLength got inlined
[[patches.hook]]
before_vram = 0x80011cc0
func = "func_80011C70"
text = "ctx->r25 = recomp_osAiGetLength();"
[[patches.instruction]]
vram = 0x80011CC0
func = "func_80011C70"
value = 0x00000000 # lw t9,0x4(t8) -> nop

# Patch out ROM read
[[patches.instruction]]
vram = 0x80001300
func = "func_80001220"
value = 0x00004825 # lw t1,0x578(t9) -> or t1,zero,zero

## Commit some sins to get 0x8001B4F0-0x8001C8D4 to recompile...
# $ra is saved in $t9 because functions called before it don't correctly save $ra to the stack,
# this is not relevant since we just want to recognize this as a return statement, so override it
[[patches.instruction]]
vram = 0x8001ba28
func = "func_8001B6F0"
value = 0x03e00008  # jr $t9 -> jr $ra

# There's a function pointer table at 0x80090444 that's never written to and only has one valid
# branch. Just convert it to a jump to that one branch so recomp can reason about it.
[[patches.instruction]]
vram = 0x8001c8b0
func = "func_8001C8A0"
value = 0x0800722e # jr $s1 -> j 0x8001c8b8
